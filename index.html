<!DOCTYPE html>
<html>
    <head>
        <meta name="viewport" content="width=320,initial-scale=1,user-scalable=0" />
        <script src="microtemplating.js"></script>
        <title>Gegevenswoordenboek</title>
    </head>
    <body>
        <div class="wrapper">
            <header style="margin: 2em 0 0">
                <center>
                    <a href="/">Gegevenswoordenboek</a><br><br>
                    <input type="text" id="vind-termen" placeholder="Zoek Term">
                </center>
            </header>
            <main id="resultaten">
            </main>
        </div>
        <style>
            html, body {
                font-family: Arial
            }
            header, input {
                font-size: 1.4em;
                margin: 0.4em;
                padding: 0.4em;
            }
            .wrapper {
                max-width: 780px;
                margin: auto;
            }
            .term {
                background: #fff;
                padding: 10px 20px;
                margin: 10px 10px;
                box-shadow: 0 4px 4px #eee;
            }
            .tag {
                font-size: 0.9em;
                background: #0B71A1;
                color: white;
                padding: 0 0.2em;
                vertical-align: baseline;
            }
            .big-font {
                font-size: 1.2em;
            }
            .normal-font {

            }
            .nerd-font {
                font-family: monospace;
            }
            input {
                font-size: 1em;
            }
            a {
                color: #0B71A1;
            }
        </style>
        <script type="text/template" id="resultaat_template">
            <div class="term" data-uid="<%=term.UID%>">
                <p><span data-filter="schema:<%=term.Schema%>" class="tag"><%=term.Schema%></span> <span class="big-font"><%=term.Label%></span></p>
                <p class="normal-font"><%=term.Definitie%></p>
                <% if (attributes.length) { %>
                <p>Attributen:</p>
                <% for (var i = 0; i < attributes.length; ++i ) { %>
                    <p class="nerd-font"> - <a data-filter="<%=attributes[i]%>" href="#<%=attributes[i]%>"><%=attributes[i]%></a></p>
                <% }} %>
                <% if (term.Documentatie) { %>
                <p>Documentatie: <a href="<%=term.Documentatie%>"><%=term.Documentatie%></a></p>
                <% } %>
                <p class="nerd-font">https://schema.json.link.here</p>
            </div>
        </script>
        <script type="module">
            var terms = await fetch ('terms.json').then(rs => rs.json()).then(rs => rs.terms);
            var triples = await fetch ('triples.json').then(rs => rs.json()).then(rs => rs.triples);
            render(terms, triples);

            function filter(val) {
                val = val.toLowerCase();
                var filteredTerms;
                if (val.indexOf("schema:") !== -1) {
                    val = val.replace(/schema:/, "");
                    filteredTerms = terms.filter(function (term) {
                        return term.Schema.toLowerCase().indexOf(val) !== -1;
                    });
                } else {
                    filteredTerms = terms.filter(function (term) {
                        return term.Label.toLowerCase().indexOf(val) !== -1 ||
                            term.Definitie.toLowerCase().indexOf(val) !== -1;
                    });
                }
                render(filteredTerms, triples);
                //terms.
            }

            function render(terms, triples) {
                let html = terms.map(function (term) {
                    let data = {
                        term: term,
                        attributes: triples.filter(function (triple) {
                            return triple.Term1 === term.Label &&
                                   triple.Relatie === "... heeft kenmerk ..."
                        }).map(function (triple) {
                            return triple.Term2;
                        })
                    };
                    return tmpl("resultaat_template", data);
                });
                document.getElementById("resultaten").innerHTML = html.join("");
                let filters = document.querySelectorAll("[data-filter]");
                for (var i = 0; i < filters.length; i++) {
                    let val = filters[i].dataset.filter;
                    filters[i].onclick = function () {
                        document.getElementById('vind-termen').value = val;
                        filter(val);
                    };
                }
            }

            document.getElementById('vind-termen').onkeyup = function (e) {
                let val = e.srcElement.value;
                filter(val);
            };
        </script>
    </body>
</html>